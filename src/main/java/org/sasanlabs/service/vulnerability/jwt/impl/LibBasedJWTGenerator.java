package org.sasanlabs.service.vulnerability.jwt.impl;

import static org.sasanlabs.service.vulnerability.jwt.JWTUtils.HS256_ALGO_JAVA;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.security.InvalidKeyException;
import java.security.KeyPair;
import java.security.NoSuchAlgorithmException;
import java.text.ParseException;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;

import org.sasanlabs.service.exception.ExceptionStatusCodeEnum;
import org.sasanlabs.service.exception.ServiceApplicationException;
import org.sasanlabs.service.vulnerability.jwt.IJWTTokenGenerator;
import org.sasanlabs.service.vulnerability.jwt.JWTUtils;
import org.springframework.stereotype.Component;

import com.nimbusds.jose.JOSEException;
import com.nimbusds.jose.JWSHeader;
import com.nimbusds.jose.crypto.RSASSASigner;
import com.nimbusds.jose.util.Base64URL;

import io.jsonwebtoken.Jwts;

/**
 * Creates JWT token based on multiple libraries.
 * 
 * @author KSASAN preetkaran20@gmail.com
 */
@Component
public class LibBasedJWTGenerator implements IJWTTokenGenerator {

	public static String getBase64EncodedHMACSignedToken(byte[] token, byte[] secretKey)
			throws ServiceApplicationException, UnsupportedEncodingException {
		try {
			Mac hmacSHA256 = Mac.getInstance(HS256_ALGO_JAVA);
			SecretKeySpec hmacSecretKey = new SecretKeySpec(secretKey, HS256_ALGO_JAVA);
			hmacSHA256.init(hmacSecretKey);
			byte[] tokenSignature = hmacSHA256.doFinal(token);
			String base64EncodedSignature = JWTUtils.getBase64UrlSafeWithoutPaddingEncodedString(tokenSignature);
			return base64EncodedSignature;
		} catch (InvalidKeyException | NoSuchAlgorithmException | IOException e) {
			throw new ServiceApplicationException(ExceptionStatusCodeEnum.SYSTEM_ERROR,
					"Exception occurred while Signing token: " + JWTUtils.getString(token), e);
		}
	}

	@Override
	public String getJWTToken_HS256(String tokenToBeSigned, byte[] key)
			throws UnsupportedEncodingException, ServiceApplicationException {
		return tokenToBeSigned + JWTUtils.JWT_TOKEN_PERIOD_CHARACTER + getBase64EncodedHMACSignedToken(tokenToBeSigned.getBytes("UTF-8"), key);
	}

	@Override
	public String getJWTToken_RS256(String tokenToBeSigned, KeyPair key) throws ServiceApplicationException {
		RSASSASigner rsassaSigner = new RSASSASigner(key.getPrivate());
		String[] jwtParts = tokenToBeSigned.split(JWTUtils.JWT_TOKEN_PERIOD_CHARACTER_REGEX, -1);
		try {
			return tokenToBeSigned + JWTUtils.JWT_TOKEN_PERIOD_CHARACTER + rsassaSigner.sign(JWSHeader.parse(Base64URL.from(jwtParts[0])), JWTUtils.getBytes(tokenToBeSigned));
		} catch (UnsupportedEncodingException | JOSEException | ParseException e) {
			throw new ServiceApplicationException(ExceptionStatusCodeEnum.SYSTEM_ERROR,
					"Exception occurred while Signing token: " + tokenToBeSigned, e);
		}
	}

}
