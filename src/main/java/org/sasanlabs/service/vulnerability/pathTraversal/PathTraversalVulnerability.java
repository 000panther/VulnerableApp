package org.sasanlabs.service.vulnerability.pathTraversal;

import static org.sasanlabs.vulnerability.utils.Constants.NULL_BYTE_CHARACTER;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URISyntaxException;
import java.util.Arrays;
import java.util.List;
import java.util.function.Supplier;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.sasanlabs.internal.utility.LevelEnum;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.VulnerabilityLevel;
import org.sasanlabs.internal.utility.annotations.VulnerableServiceRestEndPoint;
import org.sasanlabs.service.bean.ResponseBean;
import org.sasanlabs.service.vulnerability.ICustomVulnerableEndPoint;
import org.sasanlabs.service.vulnerability.ParameterBean;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.sasanlabs.vulnerability.types.VulnerabilitySubType;
import org.sasanlabs.vulnerability.types.VulnerabilityType;

/**
 * Path traversal vulnerability. <a
 * href="https://en.wikipedia.org/wiki/Directory_traversal_attack">More information</a>
 *
 * @author KSASAN preetkaran20@gmail.com
 */
@VulnerableServiceRestEndPoint(
        descriptionLabel = "PATH_TRAVERSAL_VULNERABILITY",
        value = "PathTraversal",
        type = {VulnerabilityType.PATH_TRAVERSAL})
public class PathTraversalVulnerability implements ICustomVulnerableEndPoint {

    private static final String SAMPLE_VALUE_FILE_NAME = "UserInfo.json";
    private static final List<String> ALLOWED_FILE_NAMES =
            Arrays.asList(SAMPLE_VALUE_FILE_NAME, "OwaspAppInfo.json");

    private static final transient Logger LOGGER =
            LogManager.getLogger(PathTraversalVulnerability.class);

    private static final String URL_PARAM_KEY = "fileName";

    private ResponseBean<GenericVulnerabilityResponseBean<String>> readFile(
            Supplier<Boolean> condition, String fileName) {
        if (condition.get()) {
            try {
                File infoFile =
                        new File(
                                this.getClass().getResource("/").toURI().getPath()
                                        + "scripts/PathTraversal/"
                                        + fileName);
                FileInputStream infoFileStream;
                infoFileStream = new FileInputStream(infoFile);
                if (infoFileStream != null) {
                    try (BufferedReader reader =
                            new BufferedReader(new InputStreamReader(infoFileStream))) {
                        String information = reader.readLine();
                        StringBuilder payload = new StringBuilder();
                        while (information != null) {
                            payload.append(information);
                            information = reader.readLine();
                        }
                        return new ResponseBean<GenericVulnerabilityResponseBean<String>>(
                                200,
                                new GenericVulnerabilityResponseBean<>(payload.toString(), true));
                    } catch (IOException e) {
                        LOGGER.error("Following error occurred: ", e);
                    }
                }
            } catch (FileNotFoundException | URISyntaxException ex) {
                LOGGER.error("Following error occurred: ", ex);
            }
        }
        return new ResponseBean<GenericVulnerabilityResponseBean<String>>(
                200, new GenericVulnerabilityResponseBean<>());
    }

    @AttackVector(
            vulnerabilityExposed = {VulnerabilitySubType.PATH_TRAVERSAL},
            description = "PATH_TRAVERSAL_URL_PARAM_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_1,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel1(
            ParameterBean parameterBean) {
        String fileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        return this.readFile(() -> fileName != null, fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {VulnerabilitySubType.PATH_TRAVERSAL},
            description = "PATH_TRAVERSAL_URL_PARAM_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_2,
            descriptionLabel =
                    "PATH_TRAVERSAL_URL_PARAM_IF_PARENT_DIRECTORY_PATH_NOT_PRESENT_DIRECTLY_INJECTED",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel2(
            ParameterBean parameterBean) {
        String fileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        return this.readFile(
                () -> !parameterBean.getUrl().contains("../") && fileName != null, fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {VulnerabilitySubType.PATH_TRAVERSAL},
            description = "PATH_TRAVERSAL_URL_PARAM_IF_DOT_DOT_PATH_NOT_PRESENT_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_3,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel3(
            ParameterBean parameterBean) {
        String fileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        return this.readFile(
                () -> !parameterBean.getUrl().contains("..") && fileName != null, fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {VulnerabilitySubType.PATH_TRAVERSAL},
            description =
                    "PATH_TRAVERSAL_URL_PARAM_IF_DOT_DOT_PATH_OR_%2F_NOT_PRESENT_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_4,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel4(
            ParameterBean parameterBean) {
        String fileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        return this.readFile(
                () ->
                        !parameterBean.getUrl().contains("..")
                                && !parameterBean.getUrl().contains("%2f")
                                && fileName != null,
                fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {VulnerabilitySubType.PATH_TRAVERSAL},
            description =
                    "PATH_TRAVERSAL_URL_PARAM_IF_DOT_DOT_PATH_WITH_OR_WITHOUT_URL_ENCODING_NOT_PRESENT_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_5,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel5(
            ParameterBean parameterBean) {
        String fileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        return this.readFile(() -> fileName != null && !fileName.contains(".."), fileName);
    }

    // Null Byte
    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.NULL_BYTE,
                VulnerabilitySubType.PATH_TRAVERSAL
            },
            description = "PATH_TRAVERSAL_URL_PARAM_BEFORE_NULL_BYTE_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_6,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel6(
            ParameterBean parameterBean) {
        String queryFileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        String fileName = null;
        if (queryFileName != null) {
            int indexOfNullByte = queryFileName.indexOf(NULL_BYTE_CHARACTER);
            fileName =
                    indexOfNullByte >= 0
                            ? queryFileName.substring(0, indexOfNullByte)
                            : queryFileName;
        }
        return this.readFile(
                () ->
                        queryFileName != null
                                && ALLOWED_FILE_NAMES.stream()
                                        .anyMatch(
                                                allowedFileName ->
                                                        queryFileName.contains(allowedFileName)),
                fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.NULL_BYTE,
                VulnerabilitySubType.PATH_TRAVERSAL
            },
            description =
                    "PATH_TRAVERSAL_URL_PARAM_BEFORE_NULL_BYTE_IF_PARENT_DIRECTORY_PATH_NOT_PRESENT_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_7,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel7(
            ParameterBean parameterBean) {
        String queryFileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        String fileName = null;
        if (queryFileName != null) {
            int indexOfNullByte = queryFileName.indexOf(NULL_BYTE_CHARACTER);
            fileName =
                    indexOfNullByte >= 0
                            ? queryFileName.substring(0, indexOfNullByte)
                            : queryFileName;
        }
        return this.readFile(
                () ->
                        queryFileName != null
                                && !parameterBean.getUrl().contains("../")
                                && ALLOWED_FILE_NAMES.stream()
                                        .anyMatch(
                                                allowedFileName ->
                                                        queryFileName.contains(allowedFileName)),
                fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.NULL_BYTE,
                VulnerabilitySubType.PATH_TRAVERSAL
            },
            description =
                    "PATH_TRAVERSAL_URL_PARAM_BEFORE_NULL_BYTE_IF_DOT_DOT_PATH_NOT_PRESENT_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_8,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel8(
            ParameterBean parameterBean) {
        String queryFileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        String fileName = null;
        if (queryFileName != null) {
            int indexOfNullByte = queryFileName.indexOf(NULL_BYTE_CHARACTER);
            fileName =
                    indexOfNullByte >= 0
                            ? queryFileName.substring(0, indexOfNullByte)
                            : queryFileName;
        }
        return this.readFile(
                () ->
                        queryFileName != null
                                && !parameterBean.getUrl().contains("..")
                                && ALLOWED_FILE_NAMES.stream()
                                        .anyMatch(
                                                allowedFileName ->
                                                        queryFileName.contains(allowedFileName)),
                fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.NULL_BYTE,
                VulnerabilitySubType.PATH_TRAVERSAL
            },
            description =
                    "PATH_TRAVERSAL_URL_PARAM_BEFORE_NULL_BYTE_IF_DOT_DOT_PATH_OR_%2F_NOT_PRESENT_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_9,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel9(
            ParameterBean parameterBean) {
        String queryFileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        String fileName = null;
        if (queryFileName != null) {
            int indexOfNullByte = queryFileName.indexOf(NULL_BYTE_CHARACTER);
            fileName =
                    indexOfNullByte >= 0
                            ? queryFileName.substring(0, indexOfNullByte)
                            : queryFileName;
        }
        return this.readFile(
                () ->
                        queryFileName != null
                                && !parameterBean.getUrl().contains("..")
                                && !parameterBean.getUrl().contains("%2f")
                                && ALLOWED_FILE_NAMES.stream()
                                        .anyMatch(
                                                allowedFileName ->
                                                        queryFileName.contains(allowedFileName)),
                fileName);
    }

    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.NULL_BYTE,
                VulnerabilitySubType.PATH_TRAVERSAL
            },
            description =
                    "PATH_TRAVERSAL_URL_PARAM_BEFORE_NULL_BYTE_IF_DOT_DOT_PATH_WITH_OR_WITHOUT_URL_ENCODING_NOT_PRESENT_DIRECTLY_INJECTED")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_10,
            descriptionLabel = "PATH_TRAVERSAL_URL_CONTAINING_FILENAME",
            htmlTemplate = "LEVEL_1/PathTraversal",
            parameterName = URL_PARAM_KEY,
            sampleValues = {SAMPLE_VALUE_FILE_NAME})
    public ResponseBean<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel10(
            ParameterBean parameterBean) {
        String queryFileName = parameterBean.getQueryParamKeyValueMap().get(URL_PARAM_KEY);
        String fileName = null;
        if (queryFileName != null) {
            int indexOfNullByte = queryFileName.indexOf(NULL_BYTE_CHARACTER);
            fileName =
                    indexOfNullByte >= 0
                            ? queryFileName.substring(0, indexOfNullByte)
                            : queryFileName;
        }
        return this.readFile(
                () ->
                        queryFileName != null
                                && !queryFileName.contains("..")
                                && ALLOWED_FILE_NAMES.stream()
                                        .anyMatch(
                                                allowedFileName ->
                                                        queryFileName.contains(allowedFileName)),
                fileName);
    }
}
