package org.sasanlabs.service.vulnerability.xss.persistent;

import java.util.function.Function;
import java.util.regex.Pattern;
import org.apache.commons.text.StringEscapeUtils;
import org.sasanlabs.internal.utility.LevelEnum;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.ResponseType;
import org.sasanlabs.internal.utility.annotations.VulnerabilityLevel;
import org.sasanlabs.internal.utility.annotations.VulnerableServiceRestEndPoint;
import org.sasanlabs.service.bean.ResponseBean;
import org.sasanlabs.service.vulnerability.ICustomVulnerableEndPoint;
import org.sasanlabs.service.vulnerability.ParameterBean;
import org.sasanlabs.vulnerability.types.VulnerabilitySubType;
import org.sasanlabs.vulnerability.types.VulnerabilityType;
import org.sasanlabs.vulnerability.utils.Constants;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpMethod;

/** @author preetkaran20@gmail.com KSASAN */
@VulnerableServiceRestEndPoint(
        descriptionLabel = "XSS_VULNERABILITY",
        value = "PersistentXSSInHTMLTagVulnerability",
        type = VulnerabilityType.XSS)
public class PersistentXSSInHTMLTagVulnerability implements ICustomVulnerableEndPoint {

    private static final String SAMPLE_VALUE = "Amazing";
    private static final String PARAMETER_NAME = "comment";
    private static final Pattern IMG_INPUT_TAG_PATTERN = Pattern.compile("(<img)|(<input)+");
    private static final Pattern IMG_INPUT_TAG_CASE_INSENSITIVE_PATTERN =
            Pattern.compile("((?i)<img)|((?i)<script)+");

    @Autowired private PostRepository postRepository;

    /**
     * Common utility for returning the Payload provided the Level and the computation applied on
     * post's content.
     *
     * @param parameterBean
     * @param level as we are storing posts per level so that they don't interfere between levels.
     * @param function to be applied on the data from DB before returning.
     * @return
     */
    private String getCommentsPayload(
            ParameterBean parameterBean, LevelEnum level, Function<String, String> function) {
        if (parameterBean.getQueryParamKeyValueMap().containsKey(PARAMETER_NAME)) {
            Post post = new Post();
            post.setLevelIdentifier(level);
            post.setContent(parameterBean.getQueryParamKeyValueMap().get(PARAMETER_NAME));
            this.postRepository.save(post);
        }
        StringBuilder posts = new StringBuilder();
        this.postRepository
                .findAll()
                .forEach(
                        (post) -> {
                            if (post.getLevelIdentifier().equals(level)) {
                                posts.append(
                                        "<div id=\"comments\">"
                                                + function.apply(post.getContent())
                                                + "</div>");
                            }
                        });
        return posts.toString();
    }

    /**
     * Validates if the post contains the provides pattern. This method represents some kind of
     * validator which is vulnerable to Null Bytes
     *
     * @param post
     * @param patter
     * @return
     */
    private boolean nullByteVulnerablePatternChecker(String post, Pattern pattern) {
        boolean containsHarmfulTags = false;
        if (post.contains(Constants.NULL_BYTE_CHARACTER)) {
            containsHarmfulTags =
                    pattern.matcher(post.substring(0, post.indexOf(Constants.NULL_BYTE_CHARACTER)))
                            .find();
        } else {
            containsHarmfulTags = pattern.matcher(post).find();
        }
        return containsHarmfulTags;
    }

    // Just adding User defined input(Untrusted Data) into div tag is not secure.
    // Can be broken by various ways
    @AttackVector(
            vulnerabilityExposed = VulnerabilitySubType.PERSISTENT_XSS,
            description = "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_1,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel1(ParameterBean parameterBean) {
        return new ResponseBean<String>(
                this.getCommentsPayload(parameterBean, LevelEnum.LEVEL_1, post -> post));
    }

    @AttackVector(
            vulnerabilityExposed = VulnerabilitySubType.PERSISTENT_XSS,
            description =
                    "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG_REPLACING_IMG_AND_INPUT_TAG")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_2,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel2(ParameterBean parameterBean) {
        return new ResponseBean<String>(
                this.getCommentsPayload(
                        parameterBean,
                        LevelEnum.LEVEL_2,
                        post -> IMG_INPUT_TAG_PATTERN.matcher(post).replaceAll("")));
    }

    // <image src=" " onerror="alert(1)" >
    @AttackVector(
            vulnerabilityExposed = VulnerabilitySubType.PERSISTENT_XSS,
            description =
                    "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG_REPLACING_IMG_AND_INPUT_TAG_CASE_INSENSITIVE")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_3,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel3(ParameterBean parameterBean) {
        return new ResponseBean<String>(
                this.getCommentsPayload(
                        parameterBean,
                        LevelEnum.LEVEL_3,
                        post ->
                                IMG_INPUT_TAG_CASE_INSENSITIVE_PATTERN
                                        .matcher(post)
                                        .replaceAll("")));
    }

    @AttackVector(
            vulnerabilityExposed = VulnerabilitySubType.PERSISTENT_XSS,
            description =
                    "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG_IF_NOT_CONTAINING_ANGLE_BRACKETS")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_4,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel4(ParameterBean parameterBean) {
        return new ResponseBean<String>(
                this.getCommentsPayload(
                        parameterBean, LevelEnum.LEVEL_4, post -> post.replaceAll("[<>]*", "")));
    }

    // NullByte
    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.PERSISTENT_XSS,
                VulnerabilitySubType.NULL_BYTE
            },
            description =
                    "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG_REPLACING_IMG_AND_INPUT_TAG_IF_TAGS_ARE_PRESENT_BEFORE_NULL_BYTE")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_5,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel5(ParameterBean parameterBean) {
        Function<String, String> function =
                (post) -> {
                    boolean containsHarmfulTags =
                            this.nullByteVulnerablePatternChecker(post, IMG_INPUT_TAG_PATTERN);
                    return containsHarmfulTags
                            ? IMG_INPUT_TAG_PATTERN.matcher(post).replaceAll("")
                            : post;
                };
        return new ResponseBean<String>(
                this.getCommentsPayload(parameterBean, LevelEnum.LEVEL_5, function));
    }

    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.PERSISTENT_XSS,
                VulnerabilitySubType.NULL_BYTE
            },
            description =
                    "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG_REPLACING_IMG_AND_INPUT_TAG_CASE_INSENSITIVEIF_TAGS_ARE_PRESENT_BEFORE_NULL_BYTE")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_6,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel6(ParameterBean parameterBean) {
        Function<String, String> function =
                (post) -> {
                    boolean containsHarmfulTags =
                            this.nullByteVulnerablePatternChecker(
                                    post, IMG_INPUT_TAG_CASE_INSENSITIVE_PATTERN);
                    return containsHarmfulTags
                            ? IMG_INPUT_TAG_CASE_INSENSITIVE_PATTERN.matcher(post).replaceAll("")
                            : post;
                };
        return new ResponseBean<String>(
                this.getCommentsPayload(parameterBean, LevelEnum.LEVEL_6, function));
    }

    @AttackVector(
            vulnerabilityExposed = {
                VulnerabilitySubType.PERSISTENT_XSS,
                VulnerabilitySubType.NULL_BYTE
            },
            description =
                    "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG_AFTER_HTML_ESCAPING_POST_CONTENT_BEFORE_NULL_BYTE")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_7,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel7(ParameterBean parameterBean) {
        Function<String, String> function =
                (post) -> {
                    // This logic represents null byte vulnerable escapeHtml function
                    return post.contains(Constants.NULL_BYTE_CHARACTER)
                            ? StringEscapeUtils.escapeHtml4(
                                            post.substring(
                                                    0, post.indexOf(Constants.NULL_BYTE_CHARACTER)))
                                    + post.substring(post.indexOf(Constants.NULL_BYTE_CHARACTER))
                            : StringEscapeUtils.escapeHtml4(post);
                };
        return new ResponseBean<String>(
                this.getCommentsPayload(parameterBean, LevelEnum.LEVEL_7, function));
    }

    // as we are adding to div tag so we can leverage the Html Escape for taking care of XSS.
    @AttackVector(
            vulnerabilityExposed = VulnerabilitySubType.PERSISTENT_XSS,
            description =
                    "PERSISTENT_XSS_HTML_TAG_URL_PARAM_DIRECTLY_INJECTED_IN_DIV_TAG_AFTER_HTML_ESCAPING")
    @VulnerabilityLevel(
            value = LevelEnum.LEVEL_8,
            descriptionLabel = "PERSISTENT_XSS_HTML_TAG_URL_CONTAINING_COMMENT",
            htmlTemplate = "LEVEL_1/PersistentXSS",
            responseType = ResponseType.HTML_TAGS_ONLY,
            parameterName = PARAMETER_NAME,
            sampleValues = SAMPLE_VALUE,
            httpMethod = HttpMethod.GET)
    public ResponseBean<String> getVulnerablePayloadLevel8(ParameterBean parameterBean) {
        return new ResponseBean<String>(
                this.getCommentsPayload(
                        parameterBean,
                        LevelEnum.LEVEL_8,
                        post -> StringEscapeUtils.escapeHtml4(post)));
    }
}
